sap.ui.define(["sap/ui/core/Component","sap/base/util/ObjectPath","sap/m/Button","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/m/MessageToast"],function(e,t,s,n,r,o,a){return e.extend("aichatplugin.Component",{metadata:{manifest:"json"},init:function(){var e=this._getRenderer();var t=this.getModel("i18n").getResourceBundle();e.then(function(e){var n=new s({text:t.getText("buttonText"),press:this.onOpenChatPopover.bind(this)});e.setFooterControl("sap.m.Bar",{id:"myFooter",contentRight:[n]})}.bind(this))},onOpenChatPopover:function(e){if(!this._chatPopover){this._chatModel=new r({conversationId:self.crypto.randomUUID(),user_id:this._getUserInfo(),user_query:"",isBusy:false,enableTextArea:true,messages:[]});n.load({id:this.getId(),name:"aichatplugin.fragments.AiChatBox",controller:this}).then(function(t){this._chatPopover=t;e.getSource().addDependent(t);t.attachAfterOpen(()=>{this._attachEnterHandler()});t.setModel(this._chatModel,"chatModel");t.setModel(this.getModel());t.openBy(e.getSource())}.bind(this))}else if(this._chatPopover.isOpen()){this._chatPopover.close()}else{this._chatPopover.openBy(e.getSource())}},_attachEnterHandler:function(){const e=this.byFragmentId("chatInput");const t=e.getDomRef("inner");if(!t||this._bEnterHandler)return;t?.addEventListener("keydown",function(e){if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();this.onSendMessage()}}.bind(this));this._bEnterHandler=true},_getUserInfo:function(){const e=sap.ushell.Container.getService("UserInfo");return e.getEmail()||"dummy.user@com"},onSendMessage:function(){const e=this._chatModel.getProperty("/user_query");if(!e||!e.trim())return;this._chatModel.setProperty("/user_query","");var t=this.getModel();var s=new Date;var n=t.bindContext("/getChatRagResponse(...)");n.setParameter("conversationId",this._chatModel.getProperty("/conversationId"));n.setParameter("messageId",self.crypto.randomUUID());n.setParameter("message_time",s);n.setParameter("user_id",this._chatModel.getProperty("/user_id"));n.setParameter("user_query",e);const r=!(this._chatModel.getProperty("/messages")?.length>0);this._addChatMessage(e.trim(),s,"user");this._chatModel.setProperty("/isBusy",true);n.execute().then(()=>{this._chatModel.setProperty("/isBusy",false);if(r){this.byFragmentId("historyList").getBinding("items").refresh()}var e=n.getBoundContext();var t=e.getObject();if(t){this._addChatMessage(t.content,new Date(t.messageTime),t.role)}}).catch(e=>{this._chatModel.setProperty("/isBusy",false);this._refreshMessages(this._chatModel.getProperty("/conversationId"));a.show(e.message)})},_addChatMessage:function(e,t,s){const n=this._chatModel.getProperty("/messages")||[];n.push({user_id:s==="user"?this._chatModel.getProperty("/user_id"):"AI",user_query:e,message_time:t.toISOString(),user_role:s});this._chatModel.setProperty("/messages",n);setTimeout(function(){this.byFragmentId("chatMessageArea")?.scrollTo(0,9999,200)}.bind(this),0)},onNewChat:function(){this._chatModel.setProperty("/messages",[]);this._chatModel.setProperty("/conversationId",self.crypto.randomUUID())},onDeleteChat:function(e){var t=this.byFragmentId("historyList").getSelectedContexts();o.warning("This will delete your conversation permanently",{actions:["Remove",o.Action.CANCEL],onClose:e=>{if(e!=="Remove")return;const s=t.map(e=>e.delete().then(()=>{console.log("삭제 성공:",e)}).catch(e=>{console.error("삭제 실패:",e.message)}));Promise.all(s).then(()=>{console.log("모든 삭제 작업 완료!");this.onNewChat();this.byFragmentId("historyList").getBinding("items").refresh()})}})},onSelectHistory:function(e){const t=e.getSource();const s=t.getBindingContext().getProperty("cID");this._refreshMessages(s)},_refreshMessages:function(e){this._chatModel.setProperty("/messages",[]);this._chatModel.setProperty("/conversationId",e);this._chatModel.setProperty("/isBusy",true);var t=this.getModel().bindList(`/Conversation(${e})/to_messages`);t.requestContexts().then(e=>{e.map(e=>{var t=e.getObject();this._addChatMessage(t.content,new Date(t.creation_time),t.role)});this._chatModel.setProperty("/isBusy",false)}).catch(e=>{this._chatModel.setProperty("/isBusy",false);console.log("데이터 조회 실패: "+e.message)})},byFragmentId:function(e){return n.byId(this.getId(),e)},_getRenderer:function(){return new Promise(function(e,s){this._oShellContainer=t.get("sap.ushell.Container");if(!this._oShellContainer){s("Illegal state: shell container not available; this component must be executed in a unified shell runtime context.")}else{var n=this._oShellContainer.getRenderer();if(n){e(n)}else{this._onRendererCreated=function(t){n=t.getParameter("renderer");if(n){e(n)}else{s("Illegal state: shell renderer not available after receiving 'rendererLoaded' event.")}};this._oShellContainer.attachRendererCreatedEvent(this._onRendererCreated)}}}.bind(this))},exit:function(){if(this._oShellContainer&&this._onRendererCreated){this._oShellContainer.detachRendererCreatedEvent(this._onRendererCreated)}}})});
//# sourceMappingURL=Component.js.map